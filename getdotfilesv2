#!/bin/bash

username="udunuss"
branch="main"
repo="dotfiles"
from_to=("nvim;$HOME/.config")

# Function to parse JSON and extract values
parse_json() {
    local json="$1"
    local key="$2"
    echo "$json" | sed -n "s/.*\"$key\":\s*\"\([^\"]*\)\".*/\1/p"
}

download_folder() {
    local from=$1
    local to=$2
    local api_url="https://api.github.com/repos/$username/$repo/contents/$from?ref=$branch"
    local response=$(wget -qO- --header="Accept: application/vnd.github.v3+json" "$api_url")

    # Process each item in the response
    while read -r item; do
        name=$(parse_json "$item" "name")
        path=$(parse_json "$item" "path")
        type=$(parse_json "$item" "type")
        
        if [ "$type" == "file" ]; then
            download_url=$(parse_json "$item" "download_url")
            local_path="$to/$path"
            local_dir=$(dirname "$local_path")
            
            mkdir -p "$local_dir"
            
            if [ -f "$local_path" ]; then
                local_date=$(stat -c %Y "$local_path")
                commit_info=$(wget -qO- --header="Time-Zone: UTC" "https://api.github.com/repos/$username/$repo/commits?path=$path")
                commit_date=$(parse_json "$commit_info" "date")
                local_date=$(date -d "@$local_date" +%s)
                commit_date=$(date -d "$commit_date" +%s)
                
                if [[ "$commit_date" -gt "$local_date" ]]; then
                    echo "Updating $local_path"
                    wget -qO "$local_path" "$download_url"
                else
                    echo "No update needed for $local_path"
                fi
            else
                echo "Downloading $local_path"
                wget -qO "$local_path" "$download_url"
            fi
        elif [ "$type" == "dir" ]; then
            download_folder "$path" "$to"
        fi
    done <<< "$(echo "$response" | grep -o '{[^}]*}')"
}

for f in "${from_to[@]}"; do
    from=$(echo "$f" | cut -d ";" -f 1)
    to=$(echo "$f" | cut -d ";" -f 2)
    download_folder "$from" "$to"
done
