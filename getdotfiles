#!/bin/bash
set -e
set -o pipefail

username="udunuss"
branch="main"
repo="dotfiles"
from_to=(".config;$HOME" "usr;")

# GitHub Personal Access Token (PAT)
# Create a PAT at https://github.com/settings/tokens and set it as an environment variable:
# export GITHUB_PAT=your_token_here
GITHUB_PAT=${GITHUB_PAT:-}

# Debug flag (set to true to enable debug output)
DEBUG=${DEBUG:-false}

# Temporary directory for cloning the repository
TEMP_DIR=$(mktemp -d)

debug_output() {
    if [ "$DEBUG" = true ]; then
        echo "DEBUG: $1" >&2
    fi
}

clone_repository() {
    local clone_url="https://github.com/$username/$repo.git"
    if [ -n "$GITHUB_PAT" ]; then
        clone_url="https://$GITHUB_PAT@github.com/$username/$repo.git"
    fi
    git clone --depth 1 --branch "$branch" "$clone_url" "$TEMP_DIR"
}

update_dotfiles() {
    for mapping in "${from_to[@]}"; do
        local from=$(echo "$mapping" | cut -d ";" -f 1)
        local to=$(echo "$mapping" | cut -d ";" -f 2)
        to="$to/$from"
        if [ ! -d "$TEMP_DIR/$from" ]; then
            echo "Error: Source directory $from not found in the repository" >&2
            continue
        fi
        find "$TEMP_DIR/$from" -type f | while read -r src_file; do
            local rel_path="${src_file#$TEMP_DIR/$from/}"
            local dest_file="$to/$rel_path"
            local dest_dir=$(dirname "$dest_file")
            if [ ! -d "$dest_dir" ]; then
                if ! mkdir -p "$dest_dir" 2>/dev/null; then
                    echo "Sudo required to create directory: $dest_dir"
                    sudo mkdir -p "$dest_dir"
                fi
            fi
            if [ ! -f "$dest_file" ] || ! cmp -s "$src_file" "$dest_file"; then
                if ! cp "$src_file" "$dest_file" 2>/dev/null; then
                    echo "Sudo required to update file: $dest_file"
                    sudo cp "$src_file" "$dest_file"
                fi
                echo "Updated: $dest_file"
            else
                echo "No update needed for $dest_file"
            fi
        done
    done
}

cleanup() {
    debug_output "Cleaning up temporary directory: $TEMP_DIR"
    rm -rf "$TEMP_DIR"
}

echo "Starting dotfiles update script..."
if [ -n "$GITHUB_PAT" ]; then
    echo "Using GitHub Personal Access Token for authentication."
else
    echo "No GitHub Personal Access Token provided. Cloning may be subject to stricter rate limiting."
fi

if [ "$DEBUG" = true ]; then
    echo "Debug mode is enabled."
else
    echo "Debug mode is disabled. Set DEBUG=true to enable debug output."
fi

trap cleanup EXIT

clone_repository




# Function to detect the package manager
detect_package_manager() {
    if command -v paru &> /dev/null; then
        echo "paru"
    elif command -v yay &> /dev/null; then
        echo "yay"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    else
        echo "Unknown"
    fi
}

# Function to install a package
install_package() {
    local package=$1
    local pkg_manager=$(detect_package_manager)
    
    case $pkg_manager in
        paru|yay)
            $pkg_manager -S --noconfirm $package
            ;;
        pacman)
            sudo pacman -S --noconfirm $package
            ;;
        dnf)
            sudo dnf install -y $package
            ;;
        *)
            echo "Unsupported package manager. Cannot install $package."
            return 1
            ;;
    esac
}

# Function to execute commands
execute_command() {
    local command=$1
    eval $command
}

# Main installation process
while IFS= read -r line; do
    if [[ $line == *"->"* ]]; then
        # This line contains a command to execute
        command="${line#*->}"
        echo "Executing command: $command"
        execute_command "$command"
    else
        # This line is a package to install
        package=$(echo $line | cut -d'[' -f1)
        echo "Installing package: $package"
        install_package "$package"
    fi
done << cat $TEMP_DIR/pkgs.install

update_dotfiles
echo "Dotfiles update complete."
